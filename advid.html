<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Vídeos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <style>
        :root {
            --bg-color: #121212; --sidebar-bg: #1e1e1e; --card-bg: #282828; --primary-text: #ffffff;
            --secondary-text: #b3b3b3; --accent-color: #1db954; --error-color: #f44336;
            --success-color: #4caf50; --border-color: #404040; --warning-color: #ff9800;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--primary-text); margin: 0; padding: 30px; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--sidebar-bg); padding: 30px; border-radius: 8px; }
        h1, h2 { text-align: center; color: var(--accent-color); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--secondary-text); }
        input, select, textarea { width: 100%; padding: 10px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--primary-text); font-size: 1rem; }
        .choices__inner { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px; font-size: 1rem; min-height: 40px; }
        .choices__list--dropdown, .choices__list[aria-expanded] { background-color: var(--card-bg); border-color: var(--border-color); }
        .choices__item--choice { color: var(--primary-text); }
        .choices__item--selectable.is-highlighted { background-color: var(--accent-color); }
        .choices[data-type*="select-multiple"] .choices__button { border-left: 1px solid var(--border-color); margin-top: 4px; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        button { color: #fff; border: none; padding: 12px 20px; font-size: 1rem; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        #btn-save { background-color: var(--accent-color); } #btn-save:hover { background-color: #1ed760; }
        #btn-new { background-color: #007bff; }
        #btn-delete { background-color: var(--error-color); }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .tags-panel { background-color: var(--card-bg); padding: 15px; border-radius: 4px; margin-top: 10px; }
        .tags-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .tags-input-group select, .tags-input-group input, .tags-input-group button { flex: 1; margin: 0; }
        #tags-display { display: flex; flex-wrap: wrap; gap: 8px; min-height: 20px; }
        .tag-item-editor { background-color: var(--sidebar-bg); padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .tag-item-editor .remove-tag { cursor: pointer; color: var(--error-color); font-weight: bold; }
        #status-message { text-align: center; padding: 10px; margin-top: 20px; border-radius: 4px; font-weight: bold; display: none; }
        #status-message.success { background-color: var(--success-color); display: block; }
        #status-message.error { background-color: var(--error-color); display: block; }
        .url-preview { display: none; margin-top: 15px; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; }
        .url-preview video, .url-preview iframe { display: block; width: 100%; aspect-ratio: 16 / 9; border: none; }
        .edit-section { border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--accent-color); color: white; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); cursor: pointer; z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background-color: var(--sidebar-bg); padding: 30px; border-radius: 8px; width: 90%; max-width: 700px; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--primary-text); font-size: 24px; cursor: pointer; }
        #batch-text-input { height: 250px; resize: vertical; }
        #batch-results { margin-top: 15px; padding: 10px; background-color: var(--card-bg); border-radius: 4px; display: none; max-height: 150px; overflow-y: auto; }
        #batch-results strong { color: var(--accent-color); }
        #batch-results .error-list { color: var(--warning-color); font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Editor de Vídeos</h1>

        <div class="edit-section">
            <h2>Modo de Edição</h2>
            <div class="form-group">
                <label for="video-selector">Selecione um vídeo para editar</label>
                <select id="video-selector"></select>
            </div>
             <div class="form-actions">
                <button type="button" id="btn-new">Novo Vídeo</button>
                <button type="button" id="btn-delete" disabled>Deletar Vídeo</button>
            </div>
        </div>

        <!-- O CONTEÚDO DO FORMULÁRIO FOI REINSERIDO AQUI -->
        <form id="form-video">
            <div class="form-group">
                <label for="video-nome">Nome do Vídeo (Obrigatório)</label>
                <input type="text" id="video-nome" required>
            </div>
            <div class="form-group">
                <label for="video-data">Data (Obrigatório)</label>
                <input type="date" id="video-data" required>
            </div>
             <div class="form-group">
                <label for="video-atores">Atores (Pesquise e selecione)</label>
                <select id="video-atores" multiple></select>
            </div>
            <div class="form-group"><label for="video-estudio">Estúdio</label><input type="text" id="video-estudio"></div>
            <div class="form-group"><label for="video-imagem">URL da Imagem</label><input type="text" id="video-imagem"></div>
            <div class="form-group">
                <label for="video-pagina">URL da Página/Arquivo de Vídeo</label>
                <input type="text" id="video-pagina">
                <div id="video-pagina-preview" class="url-preview"></div>
            </div>
            <div class="form-group">
                <label>Tags de Tempo</label>
                <div class="tags-panel">
                     <div class="tags-input-group">
                        <select id="tag-selector">
                            <option value="blowjob">Blowjob</option><option value="cowgirl">Cowgirl</option><option value="missionary">Missionary</option>
                            <option value="anal">Anal</option><option value="doggy">Doggy</option><option value="tittyfuck">Tittyfuck</option>
                            <option value="cum">Cum</option><option value="piss">Piss</option><option value="feet">Feet</option>
                        </select>
                        <input type="text" id="tag-time" placeholder="Min:Seg (ex: 2:03)">
                        <button type="button" id="add-tag-btn">Adicionar</button>
                    </div>
                    <div id="tags-display"></div>
                </div>
            </div>
            <button type="submit" id="btn-save">Salvar Alterações</button>
        </form>

        <div id="status-message"></div>
    </div>

    <button class="fab" id="fab-batch-add" title="Adicionar Vídeos em Lote">+</button>

    <div class="modal-overlay" id="batch-modal">
        <div class="modal-content">
            <button class="modal-close" id="batch-modal-close">&times;</button>
            <h2>Adicionar Vídeos em Lote</h2>
            <div class="form-group">
                <label for="batch-actor-selector">Adicionar vídeos para o Ator:</label>
                <select id="batch-actor-selector"></select>
            </div>
            <div class="form-group">
                <label for="batch-text-input">Cole o texto aqui:</label>
                <textarea id="batch-text-input" placeholder="Jun 08, 2022&#10;Nome do Vídeo 06/08/22&#10;..."></textarea>
            </div>
            <button type="button" id="btn-process-batch">Processar e Salvar</button>
            <div id="batch-results"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBZEffPMXgbSHYUUrNdIS5duAVGlKlmSq0",
          authDomain: "babes-392fd.firebaseapp.com",
          projectId: "babes-392fd",
          storageBucket: "babes-392fd.appspot.com",
          messagingSenderId: "376795361631",
          appId: "1:376795361631:web:d662f2b2f2cd23b115c6ea"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let actorsCache = {};
        let allVideosMap = new Map();
        let actorsChoices, videoChoices, batchActorChoices;
        let currentVideoTags = [];
        let currentEditingVideoData = null;

        const statusMessage = document.getElementById('status-message');
        const form = document.getElementById('form-video');
        const btnSave = document.getElementById('btn-save');
        const btnNew = document.getElementById('btn-new');
        const btnDelete = document.getElementById('btn-delete');
        const urlInput = document.getElementById('video-pagina');
        const urlPreview = document.getElementById('video-pagina-preview');
        const fabBatchAdd = document.getElementById('fab-batch-add');
        const batchModal = document.getElementById('batch-modal');
        const batchModalClose = document.getElementById('batch-modal-close');
        const btnProcessBatch = document.getElementById('btn-process-batch');
        const batchResults = document.getElementById('batch-results');

        const showStatus = (message, isError = false) => { statusMessage.textContent = message; statusMessage.className = isError ? 'error' : 'success'; setTimeout(() => statusMessage.style.display = 'none', 5000); };
        const parseTimeToSeconds = (timeStr) => { if (!timeStr) return null; const parts = timeStr.split(':').map(Number); return parts.length === 2 ? parts[0] * 60 + parts[1] : (parts.length === 1 ? parts[0] : null); };
        const formatSecondsToTime = (seconds) => { const min = Math.floor(seconds / 60); const sec = seconds % 60; return `${min}:${sec.toString().padStart(2, '0')}`; };

        async function loadInitialData() {
            try {
                const snapshot = await db.collection('all').get();
                actorsCache = {};
                allVideosMap.clear();
                const actorChoicesData = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.informacoes_ator && data.informacoes_ator.nome) {
                        actorsCache[doc.id] = data;
                        actorChoicesData.push({ value: doc.id, label: data.informacoes_ator.nome });
                        if (data.videos && data.videos.length > 0) {
                            data.videos.forEach(video => { if (!allVideosMap.has(video.nome)) { allVideosMap.set(video.nome, video); } });
                        }
                    }
                });

                actorChoicesData.sort((a, b) => a.label.localeCompare(b.label));
                actorsChoices.setChoices(actorChoicesData, 'value', 'label', true);
                batchActorChoices.setChoices(actorChoicesData, 'value', 'label', true);

                const videoChoicesData = Array.from(allVideosMap.keys()).sort().map(name => ({ value: name, label: name }));
                videoChoices.setChoices(videoChoicesData, 'value', 'label', true);

            } catch (error) { showStatus('Erro ao carregar dados: ' + error.message, true); }
        }
        
        function resetForm() {
            form.reset();
            actorsChoices.removeActiveItems();
            videoChoices.removeActiveItems();
            currentVideoTags = [];
            renderTags();
            updateUrlPreview();
            currentEditingVideoData = null;
            btnDelete.disabled = true;
            btnSave.textContent = 'Salvar Novo Vídeo';
        }

        function populateFormWithVideoData(videoName) {
            const videoData = allVideosMap.get(videoName);
            if (!videoData) { resetForm(); return; }
            
            currentEditingVideoData = videoData;
            document.getElementById('video-nome').value = videoData.nome || '';
            document.getElementById('video-data').value = videoData.data || '';
            document.getElementById('video-estudio').value = videoData.estudio || '';
            document.getElementById('video-imagem').value = videoData.imagem || '';
            document.getElementById('video-pagina').value = videoData.pagina || '';

            actorsChoices.removeActiveItems();
            if (videoData.atores) {
                 const actorIdsInCache = videoData.atores.map(actorId => {
                    const found = Object.entries(actorsCache).find(([key, val]) => val.informacoes_ator.id === actorId);
                    return found ? found[0] : null;
                }).filter(Boolean);
                actorsChoices.setValue(actorIdsInCache);
            }

            currentVideoTags = videoData.tags ? [...videoData.tags] : [];
            renderTags();
            updateUrlPreview();
            btnDelete.disabled = false;
            btnSave.textContent = 'Salvar Alterações';
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('video-nome').value.trim();
            const data = document.getElementById('video-data').value;
            if (!nome || !data) { showStatus('Nome e Data do vídeo são obrigatórios.', true); return; }

            const isEditing = !!currentEditingVideoData;
            const originalName = isEditing ? currentEditingVideoData.nome : null;
            const selectedActorIds = actorsChoices.getValue(true);

            const videoData = {
                nome, data,
                atores: selectedActorIds.map(id => actorsCache[id]?.informacoes_ator?.id || id),
                estudio: document.getElementById('video-estudio').value || null,
                imagem: document.getElementById('video-imagem').value || null,
                pagina: document.getElementById('video-pagina').value || null,
                tags: currentVideoTags,
                timestamp: new Date().toISOString()
            };

            try {
                const batch = db.batch();
                let actorIdsToUpdate = new Set(selectedActorIds);
                
                if (isEditing) {
                    Object.keys(actorsCache).forEach(actorId => {
                        if (actorsCache[actorId].videos?.some(v => v.nome === originalName)) { actorIdsToUpdate.add(actorId); }
                    });
                }

                actorIdsToUpdate.forEach(actorId => {
                    const docRef = db.collection('all').doc(actorId);
                    const actorData = actorsCache[actorId];
                    let newVideos = actorData.videos ? [...actorData.videos] : [];

                    if (isEditing) { newVideos = newVideos.filter(v => v.nome !== originalName); }
                    if (selectedActorIds.includes(actorId)) { newVideos.push(videoData); }
                    batch.update(docRef, { videos: newVideos });
                });
                
                await batch.commit();
                showStatus(`Vídeo "${nome}" salvo com sucesso!`);
                resetForm();
                await loadInitialData();

            } catch (error) { showStatus('Erro ao salvar vídeo: ' + error.message, true); }
        });

        btnDelete.addEventListener('click', async () => {
            if (!currentEditingVideoData) return;
            const videoName = currentEditingVideoData.nome;
            if (!confirm(`Tem certeza que deseja deletar o vídeo "${videoName}"?`)) { return; }

            try {
                const batch = db.batch();
                let actorIdsToUpdate = new Set();
                Object.keys(actorsCache).forEach(actorId => {
                    if (actorsCache[actorId].videos?.some(v => v.nome === videoName)) { actorIdsToUpdate.add(actorId); }
                });
                actorIdsToUpdate.forEach(actorId => {
                    const docRef = db.collection('all').doc(actorId);
                    const updatedVideos = (actorsCache[actorId].videos || []).filter(v => v.nome !== videoName);
                    batch.update(docRef, { videos: updatedVideos });
                });
                await batch.commit();
                showStatus(`Vídeo "${videoName}" deletado com sucesso.`);
                resetForm();
                await loadInitialData();
            } catch (error) { showStatus('Erro ao deletar: ' + error.message, true); }
        });

        function setupTagPanel() {
            const addBtn = document.getElementById('add-tag-btn'), tagSelector = document.getElementById('tag-selector'), timeInput = document.getElementById('tag-time'), display = document.getElementById('tags-display');
            addBtn.onclick = () => { const time = parseTimeToSeconds(timeInput.value); if (time === null) { showStatus('Formato de tempo inválido. Use Min:Seg.', true); return; } currentVideoTags.push({ label: tagSelector.value, time }); renderTags(); timeInput.value = ''; };
            display.onclick = (e) => { if (e.target.classList.contains('remove-tag')) { currentVideoTags.splice(parseInt(e.target.dataset.index, 10), 1); renderTags(); } };
        }
        function renderTags() {
            document.getElementById('tags-display').innerHTML = currentVideoTags.sort((a, b) => a.time - b.time).map((tag, index) => `<span class="tag-item-editor">${tag.label} @ ${formatSecondsToTime(tag.time)} <span class="remove-tag" data-index="${index}">&times;</span></span>`).join('');
        }
        function updateUrlPreview() {
            const url = urlInput.value.trim();
            if (!url) { urlPreview.innerHTML = ''; urlPreview.style.display = 'none'; return; }
            const isVideoFile = /\.(mp4|webm|ogg)(\?.*)?$/i.test(url);
            urlPreview.innerHTML = isVideoFile ? `<video src="${url}" controls muted></video>` : `<iframe src="${url}" frameborder="0"></iframe>`;
            urlPreview.style.display = 'block';
        }

        fabBatchAdd.addEventListener('click', () => { batchModal.style.display = 'flex'; });
        batchModalClose.addEventListener('click', () => { batchModal.style.display = 'none'; });
        batchModal.addEventListener('click', (e) => { if (e.target === batchModal) { batchModal.style.display = 'none'; } });

        btnProcessBatch.addEventListener('click', async () => {
            const actorId = batchActorChoices.getValue(true);
            const rawText = document.getElementById('batch-text-input').value;
            if (!actorId) { alert("Por favor, selecione um ator."); return; }
            if (!rawText.trim()) { alert("A caixa de texto está vazia."); return; }
            const targetActor = actorsCache[actorId];
            if (!targetActor) { alert("Ator não encontrado."); return; }
            
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            const newVideos = [];
            
            for (let i = 0; i < lines.length; i++) {
                const potentialDate = new Date(lines[i]);
                if (!isNaN(potentialDate.getTime()) && (i + 1) < lines.length) {
                    const isoDate = potentialDate.toISOString().split('T')[0];
                    const cleanTitle = lines[i+1].replace(/\s*\d{1,2}\/\d{1,2}\/\d{2,4}\s*$/, '').trim();
                    if(cleanTitle) { newVideos.push({ nome: cleanTitle, data: isoDate, timestamp: new Date().toISOString() }); }
                    i++;
                    if ((i + 1) < lines.length && !isNaN(parseInt(lines[i+1], 10))) { i++; }
                }
            }

            if (newVideos.length === 0) { batchResults.innerHTML = "Nenhum vídeo válido encontrado."; batchResults.style.display = 'block'; return; }

            const existingVideos = targetActor.videos || [];
            const videosToAdd = [];
            const duplicateVideos = [];
            newVideos.forEach(video => {
                const isDuplicate = existingVideos.some(ev => ev.nome === video.nome && ev.data === video.data);
                if (isDuplicate) { duplicateVideos.push(video.nome); } else { videosToAdd.push(video); }
            });

            let resultHTML = `<strong>Processamento Concluído:</strong><br>- ${videosToAdd.length} novos vídeos serão adicionados.<br>- ${duplicateVideos.length} vídeos ignorados.`;
            if (duplicateVideos.length > 0) { resultHTML += `<div class="error-list">Repetidos: ${duplicateVideos.join(', ')}</div>`; }
            batchResults.innerHTML = resultHTML;
            batchResults.style.display = 'block';

            if (videosToAdd.length > 0) {
                try {
                    await db.collection('all').doc(actorId).update({ videos: [...existingVideos, ...videosToAdd] });
                    await loadInitialData(); 
                } catch (error) { showStatus('Erro ao salvar em lote: ' + error.message, true); }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            actorsChoices = new Choices('#video-atores', { removeItemButton: true, placeholder: true, placeholderValue: 'Pesquisar atores...' });
            videoChoices = new Choices('#video-selector', { placeholder: true, placeholderValue: 'Pesquisar um vídeo...', shouldSort: false });
            batchActorChoices = new Choices('#batch-actor-selector', { placeholder: true, placeholderValue: 'Pesquisar um ator...', shouldSort: false });
            
            document.getElementById('video-selector').addEventListener('change', (e) => populateFormWithVideoData(e.target.value));
            btnNew.addEventListener('click', resetForm);
            urlInput.addEventListener('input', updateUrlPreview);

            loadInitialData();
            setupTagPanel();
        });
    </script>
</body>
</html>
