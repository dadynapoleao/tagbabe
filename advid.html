<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Vídeos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <style>
        :root {
            --bg-color: #121212; --sidebar-bg: #1e1e1e; --card-bg: #282828; --primary-text: #ffffff;
            --secondary-text: #b3b3b3; --accent-color: #1db954; --error-color: #f44336;
            --success-color: #4caf50; --border-color: #404040; --warning-color: #ff9800;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--primary-text); margin: 0; padding: 30px; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--sidebar-bg); padding: 30px; border-radius: 8px; }
        h1, h2 { text-align: center; color: var(--accent-color); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--secondary-text); }
        input, select, textarea { width: 100%; padding: 10px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--primary-text); font-size: 1rem; }
        .choices__inner { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px; font-size: 1rem; min-height: 40px; }
        .choices__list--dropdown, .choices__list[aria-expanded] { background-color: var(--card-bg); border-color: var(--border-color); }
        .choices__item--choice { color: var(--primary-text); }
        .choices__item--selectable.is-highlighted { background-color: var(--accent-color); }
        .choices[data-type*="select-multiple"] .choices__button { border-left: 1px solid var(--border-color); margin-top: 4px; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        button { color: #fff; border: none; padding: 12px 20px; font-size: 1rem; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        #btn-save { background-color: var(--accent-color); } #btn-save:hover { background-color: #1ed760; }
        #btn-new { background-color: #007bff; }
        #btn-delete { background-color: var(--error-color); }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .tags-panel { background-color: var(--card-bg); padding: 15px; border-radius: 4px; margin-top: 10px; }
        .tags-input-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .tags-input-group select, .tags-input-group input, .tags-input-group button { flex: 1; margin: 0; }
        .timer-display { background-color: var(--bg-color); padding: 10px 15px; border-radius: 4px; border: 1px solid var(--border-color); font-family: 'Courier New', Courier, monospace; font-weight: bold; font-size: 1.1rem; color: var(--accent-color); flex-shrink: 0; }
        #tags-display { display: flex; flex-wrap: wrap; gap: 8px; min-height: 20px; }
        .tag-item-editor { background-color: var(--sidebar-bg); padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .tag-item-editor .remove-tag { cursor: pointer; color: var(--error-color); font-weight: bold; }
        #status-message { text-align: center; padding: 10px; margin-top: 20px; border-radius: 4px; font-weight: bold; display: none; }
        #status-message.success { background-color: var(--success-color); display: block; }
        #status-message.error { background-color: var(--error-color); display: block; }
        .url-preview { display: none; margin-top: 15px; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; }
        .url-preview video, .url-preview iframe { display: block; width: 100%; aspect-ratio: 16 / 9; border: none; }
        .edit-section { border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--accent-color); color: white; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); cursor: pointer; z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background-color: var(--sidebar-bg); padding: 30px; border-radius: 8px; width: 90%; max-width: 700px; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--primary-text); font-size: 24px; cursor: pointer; }
        #batch-text-input { height: 250px; resize: vertical; }
        #batch-results { margin-top: 15px; padding: 10px; background-color: var(--card-bg); border-radius: 4px; display: none; max-height: 150px; overflow-y: auto; }
        #batch-results strong { color: var(--accent-color); }
        #batch-results .error-list { color: var(--warning-color); font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Editor de Vídeos</h1>
        <div class="edit-section">
            <h2>Modo de Edição</h2>
            <div class="form-group"><label for="video-selector">Selecione um vídeo para editar</label><select id="video-selector"></select></div>
            <div class="form-actions"><button type="button" id="btn-new">Novo Vídeo</button><button type="button" id="btn-delete" disabled>Deletar Vídeo</button></div>
        </div>
        <form id="form-video">
            <div class="form-group"><label for="video-nome">Nome do Vídeo (Obrigatório)</label><input type="text" id="video-nome" required></div>
            <div class="form-group"><label for="video-data">Data (Obrigatório)</label><input type="date" id="video-data" required></div>
            <div class="form-group"><label for="video-atores">Atores (Pesquise e selecione)</label><select id="video-atores" multiple></select></div>
            <div class="form-group"><label for="video-estudio">Estúdio</label><input type="text" id="video-estudio"></div>
            <div class="form-group"><label for="video-imagem">URL da Imagem</label><input type="text" id="video-imagem"></div>
            <div class="form-group">
                <label for="video-pagina">URL da Página/Arquivo de Vídeo</label>
                <input type="text" id="video-pagina">
                <div id="video-pagina-preview" class="url-preview"></div>
            </div>
            <div class="form-group">
                <label>Tags de Tempo</label>
                <div class="tags-panel">
                     <div class="tags-input-group">
                        <div id="video-timer" class="timer-display">--:--</div>
                        <select id="tag-selector">
                            <option value="blowjob">Blowjob</option><option value="cowgirl">Cowgirl</option><option value="missionary">Missionary</option>
                            <option value="anal">Anal</option><option value="doggy">Doggy</option><option value="tittyfuck">Tittyfuck</option>
                            <option value="cum">Cum</option><option value="piss">Piss</option><option value="feet">Feet</option>
                        </select>
                        <input type="text" id="tag-time" placeholder="Min:Seg (ex: 2:03)">
                        <button type="button" id="add-tag-btn">Adicionar</button>
                    </div>
                    <div id="tags-display"></div>
                </div>
            </div>
            <button type="submit" id="btn-save">Salvar Alterações</button>
        </form>
        <div id="status-message"></div>
    </div>

    <button class="fab" id="fab-batch-add" title="Adicionar Vídeos em Lote">+</button>
    <div class="modal-overlay" id="batch-modal">
        <!-- ... (modal content) ... -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBZEffPMXgbSHYUUrNdIS5duAVGlKlmSq0",
          authDomain: "babes-392fd.firebaseapp.com",
          projectId: "babes-392fd",
          storageBucket: "babes-392fd.appspot.com",
          messagingSenderId: "376795361631",
          appId: "1:376795361631:web:d662f2b2f2cd23b115c6ea"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let actorsCache = {};
        let allVideosMap = new Map();
        let actorsChoices, videoChoices, batchActorChoices;
        let currentVideoTags = [];
        let currentEditingVideoData = null;
        let videoPlayer = null; // --- NOVO: Referência para o elemento de vídeo

        // --- DOM Elements ---
        const statusMessage = document.getElementById('status-message');
        const form = document.getElementById('form-video');
        const btnSave = document.getElementById('btn-save');
        const btnNew = document.getElementById('btn-new');
        const btnDelete = document.getElementById('btn-delete');
        const urlInput = document.getElementById('video-pagina');
        const urlPreview = document.getElementById('video-pagina-preview');
        const timerDisplay = document.getElementById('video-timer'); // --- NOVO
        const timeInput = document.getElementById('tag-time'); // --- NOVO

        const showStatus = (message, isError = false) => { statusMessage.textContent = message; statusMessage.className = isError ? 'error' : 'success'; setTimeout(() => statusMessage.style.display = 'none', 5000); };
        const parseTimeToSeconds = (timeStr) => { if (!timeStr) return null; const parts = timeStr.split(':').map(Number); return parts.length === 2 ? parts[0] * 60 + parts[1] : (parts.length === 1 ? parts[0] : null); };
        const formatSecondsToTime = (totalSeconds) => { const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60; return `${minutes}:${seconds.toString().padStart(2, '0')}`; };

        // --- Lógica do Cronômetro ---
        function handleTimeUpdate() {
            if (!videoPlayer) return;
            const currentTime = Math.floor(videoPlayer.currentTime);
            const formattedTime = formatSecondsToTime(currentTime);
            timerDisplay.textContent = formattedTime;
            timeInput.value = formattedTime;
        }

        // --- Lógica do Preview (MODIFICADA) ---
        function updateUrlPreview() {
            const url = urlInput.value.trim();
            urlPreview.innerHTML = ''; // Limpa o container
            videoPlayer = null; // Reseta a referência
            timerDisplay.textContent = '--:--'; // Reseta o timer

            if (!url) { urlPreview.style.display = 'none'; return; }

            const isVideoFile = /\.(mp4|webm|ogg)(\?.*)?$/i.test(url);
            let playerElement;

            if (isVideoFile) {
                playerElement = document.createElement('video');
                playerElement.src = url;
                playerElement.controls = true;
                playerElement.muted = true;
                // --- NOVO: Adiciona o "escutador" de evento ---
                playerElement.addEventListener('timeupdate', handleTimeUpdate);
                videoPlayer = playerElement; // Guarda a referência
            } else {
                playerElement = document.createElement('iframe');
                playerElement.src = url;
                playerElement.frameborder = "0";
            }
            
            urlPreview.appendChild(playerElement);
            urlPreview.style.display = 'block';
        }

        // --- Resto do Script (sem alterações, apenas as funções já existentes) ---
        async function loadInitialData() { /* ... */ }
        function populateFormWithVideoData(videoName) { /* ... */ }
        function resetForm() { /* ... */ }
        async function initializePage() { /* ... */ }
        document.addEventListener('DOMContentLoaded', initializePage);
        // ... (todos os outros addEventListeners e funções)
    </script>
</body>
</html>
